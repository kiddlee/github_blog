---
title: Algorithm Service Architecture
date: 2021-02-14 08:40:09
description: "算法服务架构演变"
categories: architecture
tags: architecture
---

此系列主要记录算法服务在技术上的更新以及架构演变与其中遇到的问题：

### 1. 初始架构

项目最初功能较为简单，只是由几个模块组合，基于python2，计算框架为caffe和tensorflow。由于各个模块依赖的caffe版本不同，无法同时运行在同一个环境中，所以每个模块单独运行在一个docker中。
[正文](/2020/06/15/algorithm-service-architecture-1/)

### 2. 第一次升级

由于caffe和python2的版本停止更新，担心之后会遇到瓶颈。所以将所有程序从python2迁移到python3，并将caffe替换为tensorflow。

### 3. 第二次升级

随着业务的增长，原有架构无法满足。所以我们进行了一次大的升级。我们将公用部分提出，并形成了Core。工程上分为了两类：1、需要将多模块结果进行整合的产品，2、单独的产品。
之后兵哥来了，将ES中的数据接入Grafana，形成了监控大盘

### 4. 日志收集

机器多，查问题比较困难，搭建了一个简易的ELK平台，logstash收集nginx日志，打到一个单节点ES，在通过Kibana进行查询，查看各个机器流量，服务处理时长以及处理状态

### 5. 第三次升级

业务增长，服务实例增多。前端业务的SLB将请求直接打到算法服务的机器上(直接打到IP上)，但是算法端无法随意调整服务。为此建立的三台Tengine，将所有的SLB接到这三台机器上，并有这三台机器进行均载。

### 6. 日志工具升级

ES由单节点变为3个节点的集群，并加入IDC，办公室网络进作为Logstash三节点转发，所有节点的Logstash配置好容灾本地存储，防止数据丢失。建立Grafana大盘，方便所有人了解服务情况

### 7. 第四次升级

业务膨胀，算法模块内部调用越来越多，越来越复杂。算法服务器多撘25台。无法在进行手工或者脚本。此时引入kubernete

### 8.日志工具再次升级，打造全链路日志

引入fluntd所有日志的收集，所有日志通过fluntd打到日志服务器上，以文件的形式存储。再通logstash打到IDC内部